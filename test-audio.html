<!DOCTYPE html>
<html>
<head>
    <title>Test Audio Generation</title>
</head>
<body>
    <h1>Audio Test</h1>
    <button id="testBtn">Generate & Play Test Tone</button>
    <p id="status">Click button to test</p>
    <audio id="audioPlayer" controls></audio>

    <script>
        document.getElementById('testBtn').addEventListener('click', async () => {
            const status = document.getElementById('status');
            const player = document.getElementById('audioPlayer');

            try {
                status.textContent = 'Generating audio...';

                // Create audio context
                const sampleRate = 44100;
                const duration = 3; // 3 seconds
                const numberOfChannels = 2;
                const length = sampleRate * duration;

                const offlineContext = new OfflineAudioContext(numberOfChannels, length, sampleRate);
                const buffer = offlineContext.createBuffer(numberOfChannels, length, sampleRate);

                // Generate 440Hz tone
                const frequency = 440;
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const channelData = buffer.getChannelData(channel);
                    for (let i = 0; i < length; i++) {
                        const fadeTime = sampleRate * 0.5;
                        let envelope = 1.0;
                        if (i < fadeTime) {
                            envelope = i / fadeTime;
                        } else if (i > length - fadeTime) {
                            envelope = (length - i) / fadeTime;
                        }
                        channelData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * envelope * 0.3; // 30% volume
                    }
                }

                const source = offlineContext.createBufferSource();
                source.buffer = buffer;
                source.connect(offlineContext.destination);
                source.start();

                const renderedBuffer = await offlineContext.startRendering();

                // Convert to WAV
                const wav = audioBufferToWav(renderedBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });

                status.textContent = `Generated ${blob.size} bytes. Playing...`;

                // Play it
                const url = URL.createObjectURL(blob);
                player.src = url;
                player.play();

            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                console.error(error);
            }
        });

        function audioBufferToWav(buffer) {
            const numOfChan = buffer.numberOfChannels;
            const length = buffer.length * numOfChan * 2 + 44;
            const bufferArray = new ArrayBuffer(length);
            const view = new DataView(bufferArray);
            let offset = 0;
            let pos = 0;

            const setUint16 = (data) => {
                view.setUint16(pos, data, true);
                pos += 2;
            };

            const setUint32 = (data) => {
                view.setUint32(pos, data, true);
                pos += 4;
            };

            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8);
            setUint32(0x45564157); // "WAVE"
            setUint32(0x20746d66); // "fmt "
            setUint32(16);
            setUint16(1); // PCM
            setUint16(numOfChan);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2);
            setUint16(16);
            setUint32(0x61746164); // "data"
            setUint32(length - pos - 4);

            const channels = [];
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }

            while (pos < length) {
                for (let i = 0; i < numOfChan; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7fff;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }

            return bufferArray;
        }
    </script>
</body>
</html>
